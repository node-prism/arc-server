var V=Object.create;var h=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var L=(n,e,t)=>e in n?h(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var _=(n,e)=>{for(var t in e)h(n,t,{get:e[t],enumerable:!0})},A=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of D(e))!N.call(n,r)&&r!==t&&h(n,r,{get:()=>e[r],enumerable:!(s=j(e,r))||s.enumerable});return n};var O=(n,e,t)=>(t=n!=null?V(Q(n)):{},A(e||!n||!n.__esModule?h(t,"default",{value:n,enumerable:!0}):t,n)),z=n=>A(h({},"__esModule",{value:!0}),n);var f=(n,e,t)=>(L(n,typeof e!="symbol"?e+"":e,t),t);var G={};_(G,{ArcServer:()=>l});module.exports=z(G);var u=require("@prsm/arc"),I=require("@prsm/duplex"),W=require("events");var d=O(require("crypto"),1),p=require("ecdsa-sig-formatter"),R=["HS256","HS384","HS512","RS256","RS384","RS512"];function F(n){return R.includes(n)}var B={HS256:b(256),HS384:b(384),HS512:b(512),RS256:S(256),RS384:S(384),RS512:S(512),ES256:K(256)};function b(n){function e(s,r){return d.default.createHmac(`sha${n}`,r).update(s).digest("base64")}function t(s,r,o){return e(s,o)===r}return{sign:e,verify:t}}function S(n){let e=`RSA-SHA${n}`;function t(r,o){return d.default.createSign(e).update(r).sign(o.toString(),"base64")}function s(r,o,i){let a=d.default.createVerify(e);return a.update(r),a.verify(i,o,"base64")}return{sign:t,verify:s}}function K(n){let e=`RSA-SHA${n}`;function t(r,o){let i=d.default.createSign(e).update(r).sign({key:o.toString()},"base64");return(0,p.derToJose)(i,`ES${n}`)}function s(r,o,i){o=(0,p.joseToDer)(o,`ES${n}`).toString("base64");let a=d.default.createVerify(e);return a.update(r),a.verify(i,o,"base64")}return{sign:t,verify:s}}function P(n){let e=JSON.stringify(n);return H(Buffer.from(e).toString("base64"))}function $(n){let e=Buffer.from(v(n),"base64").toString("utf-8");return JSON.parse(e)}function H(n){return n.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function v(n){n=n.toString();let e=4-n.length%4;if(e!==4)for(let t=0;t<e;t++)n+="=";return n.replace(/-/g,"+").replace(/_/g,"/")}function q(n,e,t="HS256"){if(!F(t))throw new Error(`${t} is an invalid algorithm type. Must be one of ${R}`);let s=P({alg:t,type:"JWT"}),r=P(n),o=`${s}.${r}`,i=B[t],a=H(i.sign(o,e));return`${o}.${a}`}function M(n){let e=n.split(".");if(e.length!==3)throw new Error(`Decode expected 3 parts to encoded token, got ${e.length}`);let t=$(e[0]),s=$(e[1]),r=Buffer.from(v(e[2]),"base64");return{header:t,payload:s,signature:r}}function J(n,e,t={}){let s=M(n),{payload:r}=s,o=n.split("."),i=t.alg??s.header.alg,a=Date.now(),g=B[i],c={decoded:s};return(t.sig===void 0||t.sig===!0)&&(c.sig=g.verify(`${o[0]}.${o[1]}`,v(o[2]),e)),r.exp!==void 0&&(c.exp=r.exp<a),r.nbf!==void 0&&(c.nbf=a>=r.nbf),t.iat!==void 0&&(c.iat=r.iat===t.iat),t.iss!==void 0&&(c.iss=r.iss===t.iss),t.jti!==void 0&&(c.jti=r.jti!==t.jti),t.sub!==void 0&&(c.sub=r.sub===t.sub),t.aud!==void 0&&(c.aud=r.aud===t.aud),c}var m=n=>{let e;try{e=J(n,process.env.ACCESS_TOKEN_SECRET||"SECRET")}catch(t){return{valid:!1,reason:`Failed to parse token: ${t.message}`}}return e.sig?{valid:!0}:{valid:!1,reason:"Invalid signature"}},U=n=>{let e={iat:Date.now(),sub:n,permissions:{}};return q(e,process.env.ACCESS_TOKEN_SECRET||"SECRET")};var C=O(require("crypto"),1),T=class{algorithm;saltLength;constructor(e="sha256",t=64){this.algorithm=e,this.saltLength=t}verify(e,t){let{algorithm:s,salt:r}=this.parse(e);return this.hash(t,s,r)===e}encode(e){let t=C.default.randomBytes(this.saltLength).toString("base64");return this.hash(e,this.algorithm,t)}hash(e,t,s){let r=C.default.createHash(t);return r.update(e),r.update(s,"utf8"),`${t}:${s}:${r.digest("base64")}`}parse(e){let t=e.split(":");if(t.length!==3)throw new Error(`Invalid hash string. Expected 3 parts, got ${t.length}`);let s=t[0],r=t[1],o=t[2];return{algorithm:s,salt:r,digest:o}}},y=new T;var w=class{static init({host:e="localhost",port:t=3351,secure:s=!1,shardedCollections:r=[]}){this.emitter=new W.EventEmitter,this.queryHandler=new x(r),this.initializeCollections(),this.ensureRootUserExists(),this.createServer(e,t,s)}static initializeCollections(){this.auth.users=new u.Collection({autosync:!0,timestamps:!0,adapter:new u.FSAdapter({storagePath:".internal",name:"users"})}),this.auth.accessTokens=new u.Collection({autosync:!0,timestamps:!0,adapter:new u.FSAdapter({storagePath:".internal",name:"accessTokens"})})}static ensureRootUserExists(){this.auth.users.find({username:"root"}).length||this.auth.users.insert({username:"root",password:y.encode("root")})}static query(e){return this.queryHandler.query(e)}static createUser(e,t){if(this.auth.users.find({username:e})[0])throw new Error("User already exists");this.auth.users.insert({username:e,password:y.encode(t)})}static removeUser(e){if(!this.auth.users.find({username:e})[0])throw new Error("User does not exist");this.auth.users.remove({username:e})}static createServer(e,t,s=!1){this.duplex=new I.CommandServer({host:e,port:t,secure:s}),this.duplex.command(0,async(r,o)=>{if(this.emitter.emit("auth",{payload:r,connection:o}),!r.username||!r.password)return{error:"Invalid username or password"};let i=this.auth.users.find({username:r.username})[0];if(!i)return{error:"Invalid username or password"};if(!y.verify(i.password,r.password))return{error:"Invalid username or password"};let a=U(r.username);return this.auth.accessTokens.remove({username:r.username}),this.auth.accessTokens.insert({username:r.username,accessToken:a}),{accessToken:a}}),this.duplex.command(2,async(r,o)=>{this.emitter.emit("query",{payload:r,connection:o});let{accessToken:i}=r;return m(i).valid?this.queryHandler.query(r):{error:"Invalid access token"}}),this.duplex.command(3,async(r,o)=>{this.emitter.emit("createUser",{payload:r,connection:o});let{username:i,password:a,accessToken:g}=r;if(!i||!a)return{error:"Invalid username or password"};if(!m(g).valid)return{error:"Invalid access token"};try{return w.createUser(i,a),{success:!0}}catch(c){return{error:c.message}}}),this.duplex.command(4,async(r,o)=>{this.emitter.emit("removeUser",{payload:r,connection:o});let{username:i,password:a,accessToken:g}=r;if(!i||!a)return{error:"Invalid username or password"};if(!m(g).valid)return{error:"Invalid access token"};try{return w.removeUser(i),{success:!0}}catch(c){return{error:c.message}}})}},l=w;f(l,"queryHandler"),f(l,"duplex"),f(l,"auth",{}),f(l,"emitter");var k={autosync:!0,timestamps:!0},E=class{shardedCollections=[];collections={};constructor(e=[]){this.shardedCollections=e}getCollection(e){return this.getOrCreateCollection(e)}getOrCreateCollection(e){if(!this.collections[e]){let t=this.shardedCollections.find(s=>s.name===e);if(t){let s={...k,adapter:new u.FSAdapter({storagePath:".data",name:e})},r={...t,adapterOptions:{...t.adapterOptions,storagePath:".data",name:e}};this.collections[e]={collection:new u.ShardedCollection(s,r),options:s}}else{let s={...k,adapter:new u.FSAdapter({storagePath:".data",name:e})};this.collections[e]={collection:new u.Collection(s),options:s}}}return this.collections[e].collection}createCollectionWithOptions(e,t={}){if(this.collections[e])throw new Error(`Collection ${e} already exists`);let s={...k,...t,adapter:new u.FSAdapter({storagePath:".data",name:e})};return this.collections[e]={collection:new u.Collection(s),options:s},this.collections[e].collection}},x=class{cm;constructor(e=[]){this.cm=new E(e)}query(e){if(!e)throw new Error("A payload is required.");if(!e.collection)throw new Error("A query should include a collection property.");if(!e.operation)throw new Error("A query should include an operation property (find, insert, update, remove).");let t=this.cm.getOrCreateCollection(e.collection);if(!t)throw new Error(`The collection ${e.collection} does not exist.`);if(e.operation!=="drop"&&!e?.data?.query)throw new Error("This payload is missing a query.");let s=e?.data?.query||{},r=e?.data?.operations||{},o=e?.data?.options||{};switch(e.operation){case"drop":return t.drop();case"find":return t.find(s,o);case"insert":return t.insert(s);case"update":return t.update(s,r,o);case"remove":return t.remove(s,o);default:throw new Error(`Unsupported operation: "${e.operation}".`)}}};0&&(module.exports={ArcServer});
