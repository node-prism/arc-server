var N=Object.create;var d=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var Q=(n,e,r)=>e in n?d(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r;var M=(n,e)=>{for(var r in e)d(n,r,{get:e[r],enumerable:!0})},H=(n,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of F(e))!K.call(n,t)&&t!==r&&d(n,t,{get:()=>e[t],enumerable:!(s=D(e,t))||s.enumerable});return n};var B=(n,e,r)=>(r=n!=null?N(L(n)):{},H(e||!n||!n.__esModule?d(r,"default",{value:n,enumerable:!0}):r,n)),z=n=>H(d({},"__esModule",{value:!0}),n);var h=(n,e,r)=>(Q(n,typeof e!="symbol"?e+"":e,r),r);var Z={};M(Z,{ArcServer:()=>f});module.exports=z(Z);var l=require("@prsm/arc"),j=require("@prsm/duplex");var g=B(require("crypto"),1),m=require("ecdsa-sig-formatter"),U=["HS256","HS384","HS512","RS256","RS384","RS512"];function G(n){return U.includes(n)}var q={HS256:k(256),HS384:k(384),HS512:k(512),RS256:v(256),RS384:v(384),RS512:v(512),ES256:X(256)};function k(n){function e(s,t){return g.default.createHmac(`sha${n}`,t).update(s).digest("base64")}function r(s,t,o){return e(s,o)===t}return{sign:e,verify:r}}function v(n){let e=`RSA-SHA${n}`;function r(t,o){return g.default.createSign(e).update(t).sign(o.toString(),"base64")}function s(t,o,i){let a=g.default.createVerify(e);return a.update(t),a.verify(i,o,"base64")}return{sign:r,verify:s}}function X(n){let e=`RSA-SHA${n}`;function r(t,o){let i=g.default.createSign(e).update(t).sign({key:o.toString()},"base64");return(0,m.derToJose)(i,`ES${n}`)}function s(t,o,i){o=(0,m.joseToDer)(o,`ES${n}`).toString("base64");let a=g.default.createVerify(e);return a.update(t),a.verify(i,o,"base64")}return{sign:r,verify:s}}function J(n){let e=JSON.stringify(n);return W(Buffer.from(e).toString("base64"))}function P(n){let e=Buffer.from(E(n),"base64").toString("utf-8");return JSON.parse(e)}function W(n){return n.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function E(n){n=n.toString();let e=4-n.length%4;if(e!==4)for(let r=0;r<e;r++)n+="=";return n.replace(/-/g,"+").replace(/_/g,"/")}function S(n,e,r="HS256"){if(!G(r))throw new Error(`${r} is an invalid algorithm type. Must be one of ${U}`);let s=J({alg:r,type:"JWT"}),t=J(n),o=`${s}.${t}`,i=q[r],a=W(i.sign(o,e));return`${o}.${a}`}function Y(n){let e=n.split(".");if(e.length!==3)throw new Error(`Decode expected 3 parts to encoded token, got ${e.length}`);let r=P(e[0]),s=P(e[1]),t=Buffer.from(E(e[2]),"base64");return{header:r,payload:s,signature:t}}function p(n,e,r={}){let s=Y(n),{payload:t}=s,o=n.split("."),i=r.alg??s.header.alg,a=Date.now(),c=q[i],u={decoded:s};return(r.sig===void 0||r.sig===!0)&&(u.sig=c.verify(`${o[0]}.${o[1]}`,E(o[2]),e)),t.exp!==void 0&&(u.exp=t.exp<a),t.nbf!==void 0&&(u.nbf=a>=t.nbf),r.iat!==void 0&&(u.iat=t.iat===r.iat),r.iss!==void 0&&(u.iss=t.iss===r.iss),r.jti!==void 0&&(u.jti=t.jti!==r.jti),r.sub!==void 0&&(u.sub=t.sub===r.sub),r.aud!==void 0&&(u.aud=t.aud===r.aud),u}var T=n=>{let e;try{e=p(n,process.env.ACCESS_TOKEN_SECRET||"SECRET")}catch(r){return{valid:!1,reason:`Failed to parse token: ${r.message}`}}return e.sig?e.exp?{valid:!1,reason:"Token expired"}:{valid:!0}:{valid:!1,reason:"Invalid signature"}},V=n=>parseInt(n,10),C=n=>{let e={iat:Date.now(),exp:Date.now()+V(process.env.ACCESS_TOKEN_LIFETIME||"3600"),sub:n,permissions:{}};return S(e,process.env.ACCESS_TOKEN_SECRET||"SECRET")},x=n=>{let e={iat:Date.now(),exp:Date.now()+V(process.env.REFRESH_TOKEN_LIFETIME||"86400"),sub:n};return S(e,process.env.REFRESH_TOKEN_SECRET||"SECRET")};var R=B(require("crypto"),1),A=class{algorithm;saltLength;constructor(e="sha256",r=64){this.algorithm=e,this.saltLength=r}verify(e,r){let{algorithm:s,salt:t}=this.parse(e);return this.hash(r,s,t)===e}encode(e){let r=R.default.randomBytes(this.saltLength).toString("base64");return this.hash(e,this.algorithm,r)}hash(e,r,s){let t=R.default.createHash(r);return t.update(e),t.update(s,"utf8"),`${r}:${s}:${t.digest("base64")}`}parse(e){let r=e.split(":");if(r.length!==3)throw new Error(`Invalid hash string. Expected 3 parts, got ${r.length}`);let s=r[0],t=r[1],o=r[2];return{algorithm:s,salt:t,digest:o}}},y=new A;var w=class{static init({host:e="localhost",port:r=3351,secure:s=!1}){this.queryHandler=new O,this.initializeCollections(),this.ensureRootUserExists(),this.createServer(e,r,s)}static initializeCollections(){this.auth.users=new l.Collection({autosync:!0,timestamps:!0,adapter:new l.FSAdapter(".internal","users")}),this.auth.accessTokens=new l.Collection({autosync:!0,timestamps:!0,adapter:new l.FSAdapter(".internal","accessTokens")}),this.auth.refreshTokens=new l.Collection({autosync:!0,timestamps:!0,adapter:new l.FSAdapter(".internal","refreshTokens")})}static ensureRootUserExists(){this.auth.users.find({username:"root"}).length||this.auth.users.insert({username:"root",password:y.encode("root")})}static createUser(e,r){if(this.auth.users.find({username:e})[0])throw new Error("User already exists");this.auth.users.insert({username:e,password:y.encode(r)})}static removeUser(e){if(!this.auth.users.find({username:e})[0])throw new Error("User does not exist");this.auth.users.remove({username:e})}static createServer(e,r,s){this.duplex=new j.CommandServer({host:e,port:r,secure:!1}),this.duplex.command(0,async(t,o)=>{if(!t.username||!t.password)return{error:"Invalid username or password"};let i=this.auth.users.find({username:t.username})[0];if(!i)return{error:"Invalid username or password"};if(!y.verify(i.password,t.password))return{error:"Invalid username or password"};let a=C(t.username),c=x(t.username);return this.auth.refreshTokens.remove({username:t.username}),this.auth.refreshTokens.insert({username:t.username,accessToken:a,refreshToken:c}),this.auth.accessTokens.remove({username:t.username}),this.auth.accessTokens.insert({username:t.username,accessToken:a}),{accessToken:a,refreshToken:c}}),this.duplex.command(1,async(t,o)=>{let{accessToken:i,refreshToken:a}=t;if(!i||!a)return{error:"Invalid access token or refresh token"};let c=this.auth.refreshTokens.find({refreshToken:a})[0];if(!c)return{error:"Invalid refresh token"};if(c.accessToken!==i)return{error:"Refresh token access token mismatch"};if(!p(a,process.env.REFRESH_TOKEN_SECRET).sig)return{error:"Invalid refresh token"};let b=C(c.username),$=x(c.username);return this.auth.refreshTokens.remove({username:c.username}),this.auth.refreshTokens.insert({username:c.username,accessToken:b,refreshToken:$}),this.auth.accessTokens.remove({username:c.username}),this.auth.accessTokens.insert({username:c.username,accessToken:b}),{accessToken:b,refreshToken:$}}),this.duplex.command(2,async(t,o)=>{let{collection:i,operation:a,data:c,accessToken:u}=t;return T(u).valid?this.queryHandler.query(t,o):{error:"Invalid access token"}}),this.duplex.command(3,async(t,o)=>{let{username:i,password:a,accessToken:c}=t;if(!i||!a)return{error:"Invalid username or password"};if(!T(c).valid)return{error:"Invalid access token"};try{return w.createUser(i,a),{success:!0}}catch(u){return{error:u.message}}}),this.duplex.command(4,async(t,o)=>{let{username:i,password:a,accessToken:c}=t;if(!i||!a)return{error:"Invalid username or password"};if(!T(c).valid)return{error:"Invalid access token"};try{return w.removeUser(i),{success:!0}}catch(u){return{error:u.message}}})}},f=w;h(f,"queryHandler"),h(f,"duplex"),h(f,"auth",{});var _={autosync:!0,timestamps:!0},I=class{collections={};getCollection(e){return this.getOrCreateCollection(e)}getOrCreateCollection(e){if(!this.collections[e]){let r={..._,adapter:new l.FSAdapter(".data",e)};this.collections[e]={collection:new l.Collection(r),options:r}}return this.collections[e].collection}createCollectionWithOptions(e,r={}){if(this.collections[e])throw new Error(`Collection ${e} already exists`);let s={..._,...r,adapter:new l.FSAdapter(".data",e)};return this.collections[e]={collection:new l.Collection(s),options:s},this.collections[e].collection}},O=class{cm;constructor(){this.cm=new I}query(e,r){if(!e)throw new Error("A payload is required.");if(!e.collection)throw new Error("A query should include a collection property.");if(!e.operation)throw new Error("A query should include an operation property (find, insert, update, remove).");let s=this.cm.getOrCreateCollection(e.collection);if(!s)throw new Error(`The collection ${e.collection} does not exist.`);if(e.operation!=="drop"&&!e?.data?.query)throw new Error("This payload is missing a query.");let t=e?.data?.query||{},o=e?.data?.operations||{},i=e?.data?.options||{};switch(e.operation){case"drop":return s.drop();case"find":return s.find(t,i);case"insert":return s.insert(t);case"update":return s.update(t,o,i);case"remove":return s.remove(t,i);default:throw new Error(`Unsupported operation: "${e.operation}".`)}}};0&&(module.exports={ArcServer});
